version: 2

models:
  - name: fct_pq_events
    description: >
      Fact table capturing power quality (PQ) events detected by the S09 system.
      Each row represents a single PQ event, including information about the meter,
      concentrator, event type, event duration, and a derived date key for joining
      with the date dimension.

    config:
      contract:
        enforced: true
      meta:
        constraints:
          - type: primary_key
            columns: [quality_event_id]

    columns:
      - name: quality_event_id
        data_type: string
        description: >
          Unique identifier for each power quality event generated by the S09 system.
        tests:
          - not_null
          - unique

      - name: meter_id
        data_type: string
        description: >
          Identifier of the meter where the PQ event occurred. May not always be
          present in all dimensions if data ingestion is asynchronous or incomplete.
        tests:
          - relationships:
              to: ref('dim_electrical')
              field: meter_id
              severity: warn
          - relationships:
              to: ref('dim_addresses')
              field: meter_id
              severity: warn
          - relationships:
              to: ref('dim_supply_locations')
              field: meter_id
              severity: warn

      - name: meter_code
        data_type: string
        description: >
          Meter code reported by the S09 system for the PQ event.

      - name: concentrator
        data_type: string
        description: >
          Identifier of the concentrator responsible for collecting PQ event data
          from the meter.

      - name: date_id
        data_type: string
        description: >
          Surrogate key derived from the event timestamp (hashed date only).
          Used to join with the dim_date dimension.
        tests:
          - relationships:
              to: ref('dim_date')
              field: date_id

      - name: quality_event_timestamp
        data_type: timestamp
        description: >
          Timestamp when the PQ event was recorded.

      - name: quality_event_group_name
        data_type: string
        description: >
          High-level grouping of the PQ event, currently distinguishing PQ events
          from unknown categories.

      - name: quality_event_type_desc
        data_type: string
        description: >
          Human-readable description of the PQ event type based on its coded value
          (e.g., Undervoltage, Overvoltage, Power Failure).

      - name: quality_event_start
        data_type: timestamp
        description: >
          Timestamp indicating when the event began, if available.

      - name: quality_event_duration_s
        data_type: integer
        description: >
          Duration of the event in seconds, calculated from the difference between
          event start time and event detection time. Defaults to 0 if start time
          is unavailable.
