version: 2

models:
  - name: base_crm_data__contracts
    description: "Base staging layer for CRM contract records. Performs type casting, timestamp normalization to UTC and renames raw fields."

    config:
      contract:
        enforced: true
      meta:
        constraints:
          - type: primary_key
            columns: [contract_id]

    columns:

      - name: contract_id
        data_type: varchar
        description: "Surrogate natural key for each contract record (id from source)."
        data_tests:
          - unique
          - not_null

      - name: contractedPower
        data_type: variant
        description: "JSON or semi-structured field containing contracted power by period."

      - name: supplyPoint
        data_type: varchar
        description: "CUPS identifier of the supply point."
        data_tests:
          - not_null

      - name: economicActivity
        data_type: variant
        description: "Contract economic activity code."
        data_tests:
          - not_null

      - name: end_date
        data_type: timestamp_tz
        description: "UTC-normalized contract end date."
        data_tests:
          - not_null

      - name: energy_provider_name
        data_type: varchar
        description: "Name of the energy provider."
        data_tests:
          - not_null

      - name: responsibleEnergyContract
        data_type: variant
        description: "Identifier of the responsible party for the contract."
        data_tests:
          - not_null

      - name: init_date
        data_type: timestamp_tz
        description: "UTC-normalized contract start date."
        data_tests:
          - not_null

      - name: contract_status
        data_type: varchar
        description: "Status of the contract."
        data_tests:
          - not_null

      - name: tariff
        data_type: varchar
        description: "Assigned tariff for the contract."
        data_tests:
          - not_null

      - name: data_ingest
        data_type: timestamp_tz
        description: "UTC timestamp when the record was loaded into bronze."
        data_tests:
          - not_null

  - name: base_crm_data__selfconsumptions
    description: >
      Base incremental model for self-consumption information from CRM.
      Includes minimal casting and UTC timestamp normalization.

    config:
      contract:
        enforced: true
      meta:
        constraints:
          - type: primary_key
            columns: [selfconsumption_id]

    columns:

      - name: selfconsumption_id
        description: Primary key from source system
        data_type: varchar
        data_tests:
          - unique
          - not_null

      - name: cau_id
        data_type: varchar
        description: >
          Unique CAU identifier for the self-consumption record.
        data_tests:
          - not_null

      - name: compensation
        data_type: boolean
        description: Indicates whether surplus energy is compensated.
        data_tests:
          - not_null

      - name: configuration_type
        data_type: varchar
        description: Configuration type from CRM.
        data_tests:
          - not_null
        
      - name: conf_type_desc
        data_type: varchar
        description: Configuration type description from CRM.
        data_tests:
          - not_null

      - name: connection_type
        data_type: varchar
        description: Type of electrical connection.
        data_tests:
          - not_null

      - name: consumer_type_id
        data_type: varchar
        description: Surrogate key for selfconsumption_consumer
        data_tests:
          - not_null

      - name: consumer_type_desc
        data_type: varchar
        description: Selfconsumption_consumer desciption
        data_tests:
          - not_null    

      - name: cups
        data_type: array
        description: >
          List of supply points associated with this self-consumption.
        data_tests:
          - not_null

      - name: end_date
        data_type: timestamp_tz
        description: End date in UTC.
        data_tests:
          - not_null

      - name: excedents
        data_type: boolean
        description: Whether the installation injects surplus energy.
        data_tests:
          - not_null

      - name: generation_pot
        data_type: float
        description: Installed generation power.
        data_tests:
          - not_null

      - name: selfconsumption_owner
        data_type: varchar
        description: MD5 identifier for the owner name.
        data_tests:
          - not_null

      - name: solar_zone_id
        description: >
          Surrogate key generated from the raw solar_zone structure.
        data_type: varchar
        data_tests:
          - not_null

      - name: solar_zone_name
        description: >
          Humanâ€“readable name of the solar zone.
        data_type: varchar
        data_tests:
          - not_null

      - name: solar_zone_number
        description: >
          Numeric identifier representing the solar zone.
        data_type: integer
        data_tests:
          - not_null

      - name: selfconsumption_status_id
        data_type: varchar
        description: Hashed Status field natural id from CRM.
        data_tests:
          - not_null

      - name: status_name
        data_type: varchar
        description: Status field name from CRM.
        data_tests:
          - not_null    

      - name: cnmc_type_id
        description: >
          Identifier for the CNMC solar type.
        data_type: varchar
        data_tests:
          - not_null

      - name: cnmc_type_desc
        description: >
          Text description of the CNMC solar type.
        data_type: varchar
        data_tests:
          - not_null

      - name: cnmc_type_name
        description: >
          Internal CNMC type name represented as an integer code.
        data_type: integer
        data_tests:
          - not_null

      - name: init_date
        data_type: timestamp_tz
        description: UTC initialization date.
        data_tests:
          - not_null

      - name: data_ingest
        data_type: timestamp_tz
        description: Timestamp for bronze ingestion in UTC.
        data_tests:
          - not_null

  - name: base_crm_data__supply_points
    description: >
      Base incremental staging model for CRM supply points.
      Cleans raw CRM data: trims fields, handles Unknown values,
      standardizes codes, casts data types, and converts timestamps to UTC.

    config:
      contract:
        enforced: true
      meta:
        constraints:
          - type: primary_key
            columns: [supplyPoint]

    columns:
      - name: supplyPoint
        description: Unique supply point identifier (CUPS)
        data_type: varchar
        data_tests:
          - not_null
          - unique

      - name: street_name
        description: Information the supply point streets
        data_type: varchar
        data_tests:
          - not_null

      - name: town_name
        description: Information the supply point towns
        data_type: varchar
        data_tests:
          - not_null

      - name: postal_code
        description: Information the supply point zipcodes
        data_type: varchar
        data_tests:
          - not_null

      - name: type_address
        description: Information the supply point different address types
        data_type: varchar
        data_tests:
          - not_null

      - name: phone
        description: Information the supply point phone
        data_type: varchar
        data_tests:
          - not_null

      - name: number
        description: Information the supply point number
        data_type: varchar
        data_tests:
          - not_null

      - name: portal
        description: Information the supply point portal
        data_type: varchar
        data_tests:
          - not_null

      - name: floor
        description: Information the supply point floor
        data_type: varchar
        data_tests:
          - not_null

      - name: letter
        description: Information the supply point letter
        data_type: varchar
        data_tests:
          - not_null

      - name: province_name
        description: Information the supply point province
        data_type: varchar
        data_tests:
          - not_null

      - name: province_ine_code
        description: Information the supply point province INE (Spain) code
        data_type: varchar
        data_tests:
          - not_null

      - name: municipality_name
        description: Information the supply point municipality
        data_type: varchar
        data_tests:
          - not_null

      - name: municipality_ine_code
        description: Information the supply point municipality INE (Spain) code
        data_type: varchar
        data_tests:
          - not_null

      - name: ct_code
        description: Code of the secondary substation (CT)
        data_type: varchar
        data_tests:
          - not_null

      - name: ct_name
        description: Name of the CT (secondary substation)
        data_type: varchar
        data_tests:
          - not_null

      - name: transformer_code
        description: Transformer where the supply point is electrically connected
        data_type: varchar
        data_tests:
          - not_null

      - name: line_code
        description: Electrical line code (cleaned of leading zeros)
        data_type: varchar
        data_tests:
          - not_null

      - name: dso_id
        description: Distributor ID (DSO)
        data_type: varchar
        data_tests:
          - not_null

      - name: dso_name
        description: Distributor name (CDOS)
        data_type: varchar
        data_tests:
          - not_null

      - name: measure_tension_level
        description: Tension level for the meter point
        data_type: varchar

      - name: tension_section
        description: Tension section value
        data_type: float

      - name: meter_code
        description: Physical serial number of the meter (raw)
        data_type: varchar
        data_tests:
          - not_null

      - name: meter_tech_code
        description: Technical code of the meter technology
        data_type: varchar

      - name: meter_tech_name
        description: Name of the meter technology
        data_type: varchar

      - name: phase
        description: Electrical phase configuration of the supply point
        data_type: varchar
        data_tests:
          - not_null

      - name: point_type
        description: Type of the electrical point
        data_type: varchar
        data_tests:
          - not_null

      - name: data_ingest
        description: Timestamp when the data was ingested into Bronze (converted to UTC)
        data_type: timestamp_tz
        data_tests:
          - not_null